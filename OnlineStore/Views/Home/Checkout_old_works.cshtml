
@using Newtonsoft.Json;
@using Microsoft.AspNetCore.Http;
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewBag.Title = "Checkout";
    Layout = "~/Views/Shared/_LayoutExceptIndex.cshtml";
}

<h2>Checkout</h2>

        <div class="row">
                    <aside class="col-lg-9">
                        <div class="card">

                            <div class="table-responsive">

                                @{
                                    var stringObject = HttpContextAccessor.HttpContext.Session.GetString("cart");
                                    if (stringObject == null)
                                    {
                                        <div class="alert alert-danger">
                                            <strong>No product added to cart!</strong>
                                        </div>

                                    }
                                    else
                                    {
                                        var cartList = JsonConvert.DeserializeObject<List<Item>>(stringObject);
                                        cartList.OrderBy(m => m.Product.DiscountPrice);
                                        <table class="table table-borderless table-shopping-cart">
                                            <thead class="text-muted">

                                                <tr class="small text-uppercase">
                                                    <th scope="col">Product</th>
                                                    <th scope="col" width="120">Quantity</th>
                                                    <th scope="col" width="120">Price</th>
                                                    <th scope="col" class="text-right d-none d-md-block" width="200"> </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    int DiscountTotal = 0;
                                                    int OriginalTotal = 0;
                                                }
                                                @foreach (Item item in (List<Item>)cartList)
                                                {
                                                    int lineDiscountTotal = Convert.ToInt32(item.Quantity * item.Product.DiscountPrice);
                                                    DiscountTotal = Convert.ToInt32(@DiscountTotal + lineDiscountTotal);
                                                    int lineOriginalTotal = Convert.ToInt32(item.Quantity * item.Product.OriginalPrice);
                                                    OriginalTotal = Convert.ToInt32(@OriginalTotal + lineOriginalTotal);
                                                    <tr>
                                                        <td>
                                                            <figure class="itemside align-items-center">
                                                                <div class="aside"><img src="~/Images/@item.Product.Image" class="img-sm"></div>
                                                                <figcaption class="info">
                                                                    <a href="#" class="title text-dark">@item.Product.Name</a>
                                                                    <p class="text-muted small">Matrix: @item.Product.CategoryId <br> Brand: @item.Product.brandId</p>
                                                                </figcaption>
                                                            </figure>
                                                        </td>
                                                        <td>
                                                            <a href="@Url.Action("AddToCart", "Cart", new { productId = item.Product.Id, url = "Checkout" })">
                                                                <i class="fa fa-plus">Plus</i>
                                                            </a>
                                                            @item.Quantity
                                                            <a href="@Url.Action("DecreaseQty", "Cart", new { productId = item.Product.Id })">
                                                                <i class="fa fa-minus">Minus</i>
                                                            </a>
                                                        </td>

                                                        <td>
                                                            <div class="price-wrap">
                                                                <var class="price">@lineDiscountTotal </var>
                                                                <small class="text-muted"> @item.Product.DiscountPrice Each </small>
                                                            </div> <!-- price-wrap .// -->
                                                        </td>
                                                        @{
                                                            var sessionDiscountTotal = JsonConvert.SerializeObject(DiscountTotal);
                                                            HttpContextAccessor.HttpContext.Session.SetString("sessionDiscountTotal", sessionDiscountTotal);
                                                            var sessionOriginalTotal = JsonConvert.SerializeObject(OriginalTotal);
                                                            HttpContextAccessor.HttpContext.Session.SetString("sessionOriginalTotal", sessionOriginalTotal);
                                                        }
                                                        <td class="text-right d-none d-md-block">
                                                            <a data-original-title="Save to Wishlist" title="" href="" class="btn btn-light" data-toggle="tooltip"> <i class="fa fa-heart"></i></a>
                                                            <a href="@Url.Action("RemoveFromCart", "Cart", new { productId = item.Product.Id })" class="btn btn-light"> Remove</a>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    }
                                }


                            </div> <!-- table-responsive.// -->

                            <div class="card-body border-top">
                                <a asp-controller="Home" asp-action="FilterByPrice" class="btn btn-primary-light "><strong><< </strong>Continue Shopping</a>
                                <p class="icontext"><i class="icon text-success fa fa-truck"></i> Free Delivery within 1-2 weeks</p>
                            </div> <!-- card-body.// -->

                        </div> <!-- card.// -->

                    </aside> <!-- col.// -->
                    <aside class="col-lg-3">

                        <div class="card mb-3">
                            <div class="card-body">
                                <form>
                                    <div class="form-group">
                                        <label>Have coupon?</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="" placeholder="Coupon code">
                                            <span class="input-group-append">
                                                <button class="btn btn-primary">Apply</button>
                                            </span>
                                        </div>
                                    </div>
                                </form>
                            </div> <!-- card-body.// -->
                        </div> <!-- card.// -->
                        @{
                            var stringObject2 = HttpContextAccessor.HttpContext.Session.GetString("cart");
                            if (stringObject2 != null)
                            {
                                var SessionDiscountCost = HttpContextAccessor.HttpContext.Session.GetString("sessionDiscountTotal");
                                var Discountcost = JsonConvert.DeserializeObject<int>(SessionDiscountCost);
                                var SessionOriginalCost = HttpContextAccessor.HttpContext.Session.GetString("sessionOriginalTotal");
                                var OriginalCost = JsonConvert.DeserializeObject<int>(SessionOriginalCost);
                                int PercentValue = OriginalCost - Discountcost;
                                decimal PercentageDiscount = (decimal)(PercentValue * 100 / OriginalCost);


                                <div class="card">
                                    <div class="card-body">
                                        <dl class="dlist-align">
                                            <dt>Total price:</dt>
                                            <dd class="text-right">@OriginalCost</dd>
                                        </dl>
                                        <dl class="dlist-align">
                                            <dt>Discount:</dt>
                                            <dd class="text-right text-danger">-@PercentageDiscount% Off</dd>
                                        </dl>
                                        <dl class="dlist-align">
                                            <dt>Total:</dt>
                                            <dd class="text-right text-dark b"><strong>@Discountcost</strong></dd>
                                        </dl>
                                        <hr>
                                        <p class="text-center mb-3">
                                            <img src="bootstrap-ecommerce-html/images/misc/payments.png" height="26">
                                        </p>
                                        <a href="@Url.Action("CheckoutDetails", "Home")" class="btn btn-primary btn-block"> Make Purchase<strong> >></strong> </a>
                                        <a asp-controller="Home" asp-action="FilterByPrice" class="btn btn-light btn-block"><strong><< </strong>Continue Shopping</a>

                                    </div> <!-- card-body.// -->

                                </div> <!-- card.// -->
                            }
                        }
                    </aside> <!-- col.// -->
                </div> <!-- row.// -->

                @{
                    var stringObject1 = HttpContextAccessor.HttpContext.Session.GetString("cart");
                    if (stringObject1 == null)
                    {
                        <div class="alert alert-danger">
                            <strong>No product added to cart!</strong>
                        </div>

                    }
                    else
                    {
                        var cartList = JsonConvert.DeserializeObject<List<Item>>(stringObject1);
                        cartList.OrderBy(m => m.Product.DiscountPrice);
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Add</th>
                                    <th>Remove</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (Item item in (List<Item>)cartList)
                                {
                                    <tr>
                                        <td>@item.Product.Name</td>
                                        <td>@item.Quantity</td>
                                        <td>
                                            <a href="@Url.Action("AddToCart", "Cart", new { productId = item.Product.Id ,url="Checkout"})">
                                                <i class="fa fa-plus"></i>
                                            </a>
                                            <a href="@Url.Action("DecreaseQty", "Cart", new { productId = item.Product.Id })">
                                                <i class="fa fa-minus"></i>
                                            </a>
                                        </td>
                                        <td>
                                            <a href="@Url.Action("RemoveFromCart", "Cart", new { productId = item.Product.Id })">Remove <i class="fa fa-times"></i></a>
                                        </td>
                                    </tr>
                                }

                            </tbody>
                        </table>
                        <a class="btn btn-success" href="@Url.Action("CheckoutDetails", "Home")">Checkout >></a>

                    }
                }



