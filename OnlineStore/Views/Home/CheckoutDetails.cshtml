@using Newtonsoft.Json;
@using Microsoft.AspNetCore.Http;
@inject IHttpContextAccessor HttpContextAccessor
@{
    ViewBag.Title = "CheckoutDetails";
    Layout = "~/Views/Shared/_LayoutExceptIndex.cshtml";
}

@{
    var stringObject = HttpContextAccessor.HttpContext.Session.GetString("cart");
    if (stringObject == null)
    {

<div class="card">
    <article class="card-body">
        <header class="mb-4">
            <h4 class="card-title">Review cart</h4>
        </header>
        <div class="alert alert-danger">
            <strong>No product added to cart!</strong>
        </div>
        </article>
    </div>

    }
    else
    {
        var cartList = JsonConvert.DeserializeObject<List<Item>>(stringObject);
        int TotalCountofProducts = 0;
        cartList.OrderBy(cl => cl.Product.DiscountPrice);
<div class="card">
    <article class="card-body">
        <header class="mb-4">
            <h4 class="card-title">Review cart</h4>
        </header>
        <div class="row">
            @{
                int DiscountTotal = 0;
            }
            @foreach (Item item in (List<Item>)cartList)
            {
                int lineDiscountTotal = Convert.ToInt32(item.Quantity * item.Product.DiscountPrice);
                DiscountTotal = Convert.ToInt32(DiscountTotal + lineDiscountTotal);
                TotalCountofProducts = TotalCountofProducts + item.Quantity;
                <div class="col-md-6">
                    <figure class="itemside  mb-3">
                        <div class="aside"><img src="~/Images/@item.Product.Image" class="border img-xs"></div>
                        <figcaption class="info">
                            <p>@item.Product.Name</p>
                            <span>@item.Quantity x @item.Product.DiscountPrice = Total: @lineDiscountTotal </span>
                        </figcaption>
                    </figure>
                </div>
            }
            @{ 
                var SessionDiscountCost = HttpContextAccessor.HttpContext.Session.GetString("sessionDiscountTotal");
                var Discountcost = JsonConvert.DeserializeObject<int>(SessionDiscountCost);
                var SessionOriginalCost = HttpContextAccessor.HttpContext.Session.GetString("sessionOriginalTotal");
                var OriginalCost = JsonConvert.DeserializeObject<int>(SessionOriginalCost);
                int DiscountPercentValue = OriginalCost - Discountcost;
                decimal PercentageDiscount = (decimal)(DiscountPercentValue * 100 / OriginalCost);
            }
        </div>
    </article><!-- card-body.// -->
    <article class="card-body border-top">

        <dl class="row">
            <dt class="col-sm-10">Subtotal: <span class="float-right text-muted">@TotalCountofProducts items</span></dt>
            <dd class="col-sm-2 text-right"><strong>Rs. @OriginalCost</strong></dd>

            <dt class="col-sm-10">Discount: <span class="float-right text-muted">@PercentageDiscount% offer</span></dt>
            <dd class="col-sm-2 text-danger text-right"><strong>Rs. @DiscountPercentValue</strong></dd>

            <dt class="col-sm-10">Delivery charge: <span class="float-right text-muted">Express delivery</span></dt>
            <dd class="col-sm-2 text-right"><strong>$120</strong></dd>

            <dt class="col-sm-10">Tax: <span class="float-right text-muted">5%</span></dt>
            <dd class="col-sm-2 text-right text-success"><strong>$7</strong></dd>

            <dt class="col-sm-10">Total Amount to Pay:</dt>
            <dd class="col-sm-2 text-right"><strong class="h5 text-dark">Rs. @Discountcost</strong></dd>
        </dl>

    </article> <!-- card-body.// -->
</div>
                }
        }
       
             
            
       


        @{
            var stringObject1 = HttpContextAccessor.HttpContext.Session.GetString("cart");
            if (stringObject1 == null)
            {
                <div class="alert alert-danger">
                    <strong>No product added to cart!</strong>
                </div>

            }
            else
            {
                var cartList = JsonConvert.DeserializeObject<List<Item>>(stringObject);
                cartList.OrderBy(cl => cl.Product.DiscountPrice);
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Line Total</th>

                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int Total = 0;
                        }
                        @foreach (Item item in (List<Item>)cartList)
                        {
                            int lineTotal = Convert.ToInt32(item.Quantity * item.Product.DiscountPrice);
                            Total = Convert.ToInt32(@Total + lineTotal);



                            <tr>
                                <td>@item.Product.Name</td>
                                <td>@item.Product.DiscountPrice</td>
                                <td>@item.Quantity</td>
                                <td>@lineTotal</td>
                            </tr>
                        }
                        @{
                            var sessionTotal = JsonConvert.SerializeObject(Total);
                            HttpContextAccessor.HttpContext.Session.SetString("SessionTotal", sessionTotal);
                        }

                        <tr>
                            <td colspan="4" class="text-right"><b>Total: @Total</b></td>

                        </tr>
                    </tbody>
                </table>

                var cost = JsonConvert.DeserializeObject<int>(sessionTotal);
                <a href="@Url.Action("CheckoutDetails", "Home")" class="btn btn-primary"> Confirm Delivery Details and Pay >> </a>
                <a href="@Url.Action("AddCustomerDetails", "Home")" class="btn btn-success">Add Delivery Details and Payment Rs. @cost >></a>

            }

        }
